<html><head>
    <title>Partial Clone Rollout - Engineering Productivity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_pm8b73nd9u1k-1>li:before{content:"-  "}.lst-kix_pm8b73nd9u1k-2>li:before{content:"-  "}.lst-kix_pm8b73nd9u1k-3>li:before{content:"-  "}ul.lst-kix_pm8b73nd9u1k-1{list-style-type:none}.lst-kix_pm8b73nd9u1k-4>li:before{content:"-  "}ul.lst-kix_pm8b73nd9u1k-0{list-style-type:none}ul.lst-kix_pm8b73nd9u1k-3{list-style-type:none}.lst-kix_pm8b73nd9u1k-7>li:before{content:"-  "}ul.lst-kix_pm8b73nd9u1k-2{list-style-type:none}ul.lst-kix_pm8b73nd9u1k-5{list-style-type:none}ul.lst-kix_pm8b73nd9u1k-4{list-style-type:none}.lst-kix_pm8b73nd9u1k-5>li:before{content:"-  "}ul.lst-kix_pm8b73nd9u1k-7{list-style-type:none}ul.lst-kix_pm8b73nd9u1k-6{list-style-type:none}.lst-kix_pm8b73nd9u1k-6>li:before{content:"-  "}ul.lst-kix_pm8b73nd9u1k-8{list-style-type:none}.lst-kix_pm8b73nd9u1k-0>li:before{content:"-  "}.lst-kix_pm8b73nd9u1k-8>li:before{content:"-  "}ol{margin:0;padding:0}table td,table th{padding:0}.c12{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#fff2cc;border-left-style:solid;border-bottom-width:1pt;width:500pt;border-top-color:#000000;border-bottom-style:solid}.c1{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c2{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c8{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial"}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c10{margin-left:auto;border-spacing:0;border-collapse:collapse;margin-right:auto}.c4{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c11{background-color:#ffffff;}.c3{color:inherit;text-decoration:inherit}.c6{height:11pt}.c7{font-weight:700}.c9{height:0pt}.c5{font-style:italic}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c11 doc-content"><p class="c0"><span class="c2">git partial-clone rollout experience - Engineering Productivity &nbsp;</span></p><p class="c0"><span class="c2">&mdash;</span></p><p class="c0 c6"><span class="c2"></span></p><a id="t.9c1e60db44fa2b795d910d4f8cbb07f62d056b76"></a><a id="t.0"></a><table class="c10"><tr class="c9"><td class="c12" colspan="1" rowspan="1"><p class="c0"><span class="c5 c8">Background:</span></p><p class="c0 c6"><span class="c1"></span></p><p class="c0"><span>P</span><span>artial-clone is a git </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://git-scm.com/docs/partial-clone&amp;sa=D&amp;source=editors&amp;ust=1672110668384051&amp;usg=AOvVaw1zCzya0woqxiL7G4h0935U">feature</a></span><span>&nbsp;allowing git to function with a copy of part of the repository - in other words your git checkout can function with a mix of locally downloaded assets and on-demand downloadable (lazy) assets. Both </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://git-scm.com/docs/partial-clone/2.21.0&amp;sa=D&amp;source=editors&amp;ust=1672110668384354&amp;usg=AOvVaw3n4NmZMCQnKXLWXrzI4uHN">Git</a></span><span>, </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://docs.gitlab.com/ee/topics/git/partial_clone.html&#39;&amp;sa=D&amp;source=editors&amp;ust=1672110668384571&amp;usg=AOvVaw1SNBP983HTHYz4nK54zBt5">GitLab</a></span><span>&nbsp;and </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://github.blog/2020-12-21-get-up-to-speed-with-partial-clone-and-shallow-clone/&amp;sa=D&amp;source=editors&amp;ust=1672110668384828&amp;usg=AOvVaw2eneAZ1p7uLsBlAIJD4eHD">Github</a></span><span>&nbsp;have done an excellent job describing this functionality; I encourage you to read the implementation details. </span></p></td></tr></table><p class="c0 c6"><span class="c1"></span></p><p class="c0"><span>The checkout size for the </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://source.android.com/docs/setup/download/downloading%23getting-the-files&amp;sa=D&amp;source=editors&amp;ust=1672110668385383&amp;usg=AOvVaw1nHG8OpxD0wrRZWat7Wx0F">Android</a></span><span>&nbsp;operating system</span><span class="c1">&nbsp;has historically been a major challenge for internal and external developers, with a single checkout taking hundreds of gigs of diskspace which does not even include a build of Android which takes hundreds of GB on top of the source code. This effectively limits the number of source trees one can have checked out and built to ~4. Given the nature of Android development this sort of limitation directly impacts the productivity of engineers. I want to share how we improved this situation and how nothing is ever &ldquo;simple&rdquo;.</span></p><p class="c0 c6"><span class="c1"></span></p><p class="c0"><span>While historically Android developers have leveraged git clone </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://git-scm.com/docs/git-clone&amp;sa=D&amp;source=editors&amp;ust=1672110668385870&amp;usg=AOvVaw3wbXbncm-06rYj6m6RPobH">depth</a></span><span class="c1">&nbsp;options (shallow clone) to mitigate the size problems this came with the unfortunate tradeoff that they were unable to use tooling like git blame and git log in order to understand the history of the files they were touching. Git partial clone seemed like a perfect solution, not only do they get to retain history (through on-demand downloads of blobs and history when needed) but they are also able to significantly reduce the checkout size.</span></p><p class="c0 c6"><span class="c1"></span></p><p class="c0"><span>Our EngProd testing showed that compared to a normal (non-partial) checkout, there was a 33% decrease in disk utilization. So we began manually rolling out this functionality through the </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://gerrit-review.googlesource.com/c/git-repo/%2B/229532&amp;sa=D&amp;source=editors&amp;ust=1672110668386425&amp;usg=AOvVaw1BR2d4PcOViPzMNcuydHcD">git repo tool</a></span><span>&nbsp;to our internal developer population and almost instantly were flooded with feedback from our testing population with feedback like </span><span class="c5">:&ldquo;my editor just got really slow&rdquo; to &ldquo;when I run git commit it&rsquo;s now taking hours&rdquo;. </span><span class="c1">This was unexpected and puzzling initially, however after watching the git process tree during these slow actions we found that git was resolving all of the lazy objects (hundreds and hundreds of async fetches) inside of a synchronous workflow.</span></p><p class="c0 c6"><span class="c1"></span></p><p class="c0"><span>The root of the problem exposed that a multitude of developer tools were running git blame behind the scenes to understand what files were changed. Some were </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://android-review.googlesource.com/c/platform/prebuilts/checkstyle/%2B/1359806&amp;sa=D&amp;source=editors&amp;ust=1672110668386978&amp;usg=AOvVaw0Y3cF09SBNPJTw-vaM9ydN">trivial</a></span><span>&nbsp;to fix while others were not tractable due to their existing ecosystem integrations (</span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://github.com/JetBrains/intellij-community/blob/c22d7a7e926f9d23a600e4394f02af3e7c014690/plugins/git4idea/src/git4idea/annotate/GitAnnotationProvider.java%23L219&amp;sa=D&amp;source=editors&amp;ust=1672110668387298&amp;usg=AOvVaw2krJ18gX7tqNau_KemW53b">git layer for intellij</a></span><span class="c1">)</span></p><p class="c0 c6"><span class="c1"></span></p><p class="c0"><span>While </span><span class="c7">filter:blob=none</span><span>&nbsp;provided the most significant disk use savings, it came with an unacceptable latency tradeoff in the developer </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://docs.stakater.com/content/sre/local-development/inner-vs-outer-loop.html&amp;sa=D&amp;source=editors&amp;ust=1672110668387789&amp;usg=AOvVaw2Cojk4Rv5s3hkYEN-JKeLa">inner loop</a></span><span>. In order to identify a way to deliver this space savings, we went back to the fundamentals of exactly what and how platform development is done. Developer tooling that was in the time sensitive developer path was consistently running on text files. </span><span class="c5">Was there a way we could tune our checkout to retain history information on these files while excluding the binary files</span><span>? </span><span class="c4"><a class="c3" href="https://www.google.com/url?q=https://github.com/git/git/blob/7c2ef319c52c4997256f5807564523dfd4acdfc7/Documentation/rev-list-options.txt%23L935&amp;sa=D&amp;source=editors&amp;ust=1672110668388148&amp;usg=AOvVaw27L2pHd8Df9NvoIoiba0V7">filter-spec</a></span><span>&nbsp;does not allow a filter based on content type but it does support blob size limits. Through some quick corpus analysis we found that </span><span>99+% of files inside of the Android that were not binary files were under 10MB. Given this fact we tweaked our rollout to go from using </span><span class="c7">filter=blob:none</span><span>&nbsp;to </span><span class="c7">filter=blob:10M</span><span>&nbsp;- we went from fetching only what you need for the tip of tree checkout, to fetch all files &lt;=10MB and their history, but exclude the history of all other files until asked. This allowed developer tooling to run git blame operations quickly while at the same time saving </span><span class="c7">30%</span><span class="c1">&nbsp;of disk space when compared to the prior solution. With this one tweak we were able to complete the rollout and bring the benefits of partial clone to our developer populations. </span></p><p class="c0 c6"><span class="c1"></span></p><p class="c0 c6"><span class="c1"></span></p><p class="c0 c6"><span class="c1"></span></p></body></html>